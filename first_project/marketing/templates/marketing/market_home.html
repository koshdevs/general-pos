
{% extends 'firstapp/base.html' %}       
{% load  crispy_forms_tags %}
<!-- Main content -->
{% block mainContent %}
<style>
  .modal-backdrop.fade.show{
   display:none;
 }
</style>
<section class="content">
  <div class="container-fluid">
    <!-- Small boxes (Stat box) -->
    <div class="row">
     
      <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box bg-dark">
          <div class="inner">
            <h3># {{contacts | length }}</h3>
            
            <p>contacts list</p>
          </div>
          <div class="icon">
            <i class="ion ion-bag"></i>
          </div>
          <a href="#" class="small-box-footer">view more <i class="fas fa-arrow-circle-right"></i></a>
        </div>
      </div>
      <!-- ./col -->
      <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box bg-secondary">
            <div class="inner">
              <h3>KES {{spending}}</h3>
              
              <p>Amount spent</p>
            </div>
            <div class="icon">
              <i class="ion ion-bag"></i>
            </div>
            <a href="#" class="small-box-footer">view more <i class="fas fa-arrow-circle-right"></i></a>
          </div>
      </div>
      <!-- ./col -->
      <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box bg-success">
            <div class="inner">
              <h3># {{all_sent}}</h3>
              
              <p>messages sent</p>
            </div>
            <div class="icon">
              <i class="ion ion-bag"></i>
            </div>
            <a href="#" class="small-box-footer">view more <i class="fas fa-arrow-circle-right"></i></a>
          </div>
      </div>
      <!-- ./col -->
      <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box bg-danger">
            <div class="inner">
              <h3>KES </h3>
              
              <p>Balance</p>
            </div>
            <div class="icon">
              <i class="ion ion-bag"></i>
            </div>
            <a href="#" class="small-box-footer">view more <i class="fas fa-arrow-circle-right"></i></a>
          </div>
      </div>
 
      <div class="container rounded bg-white mt-5 mb-5">
        <div class="row">
            <div class="col-md-3 border-right">
                <div class="d-flex flex-column align-items-center text-center p-3 py-5"><img class="rounded-circle mt-5" width="150px" src="{{user.profile.image.url}}"><span class="font-weight-bold">{{user.username}}</span><span class="text-black-50">{{user.email}}</span><span> </span></div>
            </div>
            <div class="col-md-5 border-right">
                <div class="p-3 py-5">
                  <div id="contactSpinner" style="display:none; margin-left:50px"> 
                    <div class="spinner-grow text-primary" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                    <div class="spinner-grow text-secondary" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                    <div class="spinner-grow text-success" role="status">
                      <span class="sr-only">Loading...</span>
                    </div>
                  </div>
                  <button onclick="location.reload();"><i class="fa fa-refresh" aria-hidden="true"></i>refresh</button>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="text-right">upload contacts</h4><span style="color:green">phone formats: 2547xxxxxxxxx , 07xxxxxxxxx, 01xxxxxxxx</span>
                        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#delContactModal">

                          <i class="fa fa-times"> all contacts</i>
                        </button>
                        
                        <!-- Modal -->
                        <div class="modal fade" id="delContactModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                          <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <div id="delSpinner" style="display:none; margin-left:50px"> 
                                  <div class="spinner-grow text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                  </div>
                                  <div class="spinner-grow text-secondary" role="status">
                                    <span class="sr-only">Loading...</span>
                                  </div>
                                  <div class="spinner-grow text-success" role="status">
                                    <span class="sr-only">Loading...</span>
                                  </div>
                                </div>
                                <h5 class="modal-title" id="exampleModalLongTitle">sure? you want to delete all contacts</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                              </div>
                              <div class="modal-body">
                                <h4 style="color:red">this action is irreversible.</h4>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="delContacts()">proceed</button>
                              </div>
                            </div>
                          </div>
                        </div>
                    </div>
                   
                     
                    <div class="row mt-3">
                        <div class="col-md-12">
                          <div class="form-group">
                            <label for="exampleFormControlTextarea1">paste contact names (excel column)</label>
                            <textarea class="form-control" id="contact_name" rows="10"></textarea>
                          </div>
                          <div class="form-group">
                            <label for="exampleFormControlTextarea1">paste phone numbesr (excel column)</label>
                            <textarea class="form-control" id="contact_phone" rows="10"></textarea>
                          </div>
                        </div>
                       
                       
                    </div>
                   
                    <div class="mt-5 text-center"><button class="btn btn-primary profile-button" onclick="saveContacts()"><i class="fa fa-save"></i>save</button></div>
                
                </div>
            </div>
            <!--modals-->
          
            <div class="col-md-4">
                <div class="p-3 py-5">
                    <div class="d-flex justify-content-between align-items-center experience">
                      <button type="button" class="btn btn-secondary" data-toggle="modal"  data-target="#viewContactsModal"><i class="fa fa-eye">view contacts</i></button>
                      &nbsp; &nbsp;
                      <button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bd-example-modal-sm">message for saved contacts</button>
                      &nbsp; &nbsp;
                      <button type="button" class="btn btn-success" data-toggle="modal"  data-target="#unsavedModal">message for unsaved contacts</button>
                      &nbsp; &nbsp;
                      <button type="button" class="btn btn-secondary" data-toggle="modal"  data-target="#unsavedMultModal">multiple messages unsaved contacts</button>
                    
                    </div><br>
                    <div class="col-md-12">
                      <div class="row" style="margin:20px;">                          

                        <a id="msgReport"><i class="fa fa-download">download response report</i></a>
                        <table class="table align-middle mb-0 bg-white" style="margin-left:10px" id="msgsReport">
                          <thead class="bg-light">
                            <tr>
                              <th>status</th>
                              <th>phone #</th>
                              <th>network id</th>
                              <th>cost</th>
                             
                          </thead>
                          <tbody id="savedResp">
                               
                          </tbody>
                         
                        </table>
                        </div>
                        </div>
                        <br>
                    <div class="col-md-12">
                      
                      
                      <br>
                      <div class="modal fade bd-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                          <div class="modal-content">
                            <div class="modal-header">
                              <div id="plagSpinnero" style="display:none; margin-left:50px"> 
                                <div class="spinner-grow text-primary" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                                <div class="spinner-grow text-secondary" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                                <div class="spinner-grow text-success" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                              </div>
                              <h5 class="modal-title" id="exampleModalLabel">New message</h5>
                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                              </button>
                            </div>
                            <div class="row">
                            <div class="col" style="margin-left:10px;">
                          
                              {{message_form}}
                            {{message_form.media}}
                            
                            <button class="btn btn-primary" style="margin-bottom: 20px;margin-right: 10px;" onclick="sysMsg()"><i class="fa fa-plane"></i></button>
                            </div>
                            <div class="col">
                               ------------------------------------
                               <br>
                               <p style="color:yellowgreen">sends text messages to contacts already saved in the system</p>
                            </div>
                            </div>
                            
                          </div>
                          <br>
                        </div>
                      </div>
                    </div> <br>
                    <br>
                    <div class="col-md-12">
                      <br>
                     

                      <div class="modal fade bd-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" id="unsavedModal" aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                          <div class="modal-content">
                            <div class="modal-header">
                              <div id="plagSpinner1" style="display:none; margin-left:50px"> 
                                <div class="spinner-grow text-primary" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                                <div class="spinner-grow text-secondary" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                                <div class="spinner-grow text-success" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                              </div>
                              <h5 class="modal-title" id="exampleModalLabel">New message</h5>
                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                              </button>
                            </div>
                            <div class="row">
                            <div class="col" style="margin-left:10px;">
                             <label>paste excel phone column here</label>
                              <textarea  class="form-control" id="phn" rows="20"></textarea>
                            <br>
                            <button class="btn btn-primary" style="margin-bottom: 20px;margin-right: 10px;" onclick="unsavedOneMsg()"><i class="fa fa-plane">send</i></button>
                            </div>
                            <div class="col" style="margin-right:20px;">
                              <label>message</label>
                               <textarea  class="form-control" id="message" rows="20" cols="3" style="margin-right: 20px;"></textarea>
                            </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <br>

                    <div class="col-md-12">
                      

                      <div class="modal fade bd-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" id="unsavedMultModal" aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                          <div class="modal-content">
                            <div class="modal-header">
                              <div id="plagSpinner2" style="display:none; margin-left:50px"> 
                                <div class="spinner-grow text-primary" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                                <div class="spinner-grow text-secondary" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                                <div class="spinner-grow text-success" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                              </div>
                              <h5 class="modal-title" id="exampleModalLabel">New message</h5>
                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                              </button>
                            </div>
                            <div class="row">
                            <div class="col" style="margin-left:10px;">
                             <label>paste excel phone column here</label>
                              <textarea  class="form-control" id="mult_phn" rows="20"></textarea>
                            <br>
                            <button class="btn btn-primary" style="margin-bottom: 20px;margin-right: 10px;" onclick="unsavedMultMsg()"><i class="fa fa-plane">send</i></button>
                            </div>
                            <div class="col" style="margin-right:20px;">
                              <label>paste excel message column here</label>
                               <textarea  class="form-control" id="mult_msgs" rows="20" cols="3" style="margin-right: 20px;"></textarea>
                            </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-12">
                      

                      <div class="modal fade bd-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" id="viewContactsModal" aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                          <div class="modal-content">
                            <div class="modal-header">
                              <div id="plagSpinner2" style="display:none; margin-left:50px"> 
                                <div class="spinner-grow text-primary" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                                <div class="spinner-grow text-secondary" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                                <div class="spinner-grow text-success" role="status">
                                  <span class="sr-only">Loading...</span>
                                </div>
                              </div>
                              <h5 class="modal-title" id="exampleModalLabel">All Contacts</h5>
                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                              </button>
                            </div>
                            <div class="row" style="margin:20px; height:500px; overflow-y:scroll;">
                              <table class="table align-middle mb-0 bg-white" style="margin-left:10px;" id="savedContacts">
                                <thead class="bg-light">
                                  <tr>
                                    
                          
                                    <th>Name</th>
                                    <th>phone number</th>
                                    <th>created</th>
                                   
                                   
                        
                                  </tr>
                                </thead>
                                <tbody>
                                  {% for contact in contacts %}
                                  {% if contact.current_user == request.user.username %}
                                  <tr>
                                 
                                    <td>{{contact.contact_name}}</td>
                                    <td>{{contact.contact_number}}</td>
                                    <td>{{contact.contact_date}}</td>
                                    <td><button class="btn btn-danger" onclick="delCont()"><i class="fa fa-times"></i></button></td>
                                   

                                  </tr>
                                  {% endif %}
                                  {% endfor %}
                                </tbody>
                                </table>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
               
        </div>
    </div>
    </div>
    </div>
      <!-- ./col -->
    </div>


 
      

    

  </div>
</section>
<script>

function saveContacts(){
       
        $.ajax({

          url:"{% url 'market_home' %}",
          type:"POST",
          data:{
            cnames:$("#contact_name").val(),
            cphones:$("#contact_phone").val(),
            csrfmiddlewaretoken: '{{ csrf_token }}',
          },
          beforeSend:function(){

          $("#contactSpinner").show()

          },
          complete:function(){
          $("#contactSpinner").hide()
          },
          success:function(data,status){

          alert(data)
          }

        });
      }
      function sysMsg(){

        $.ajax({

          url:"{% url 'sys_msg' %}",
          type:"POST",
          data:{
            msgone:CKEDITOR.instances['id_message'].getData(),
            csrfmiddlewaretoken: '{{ csrf_token }}',
          },
          beforeSend:function(){

          $("#plagSpinnero").show()

          },
          complete:function(){
          $("#plagSpinnero").hide()
          },
          success:function(data,status){

            var results = JSON.parse(data)
                console.log(results)
               for(res in results){
                $("#savedResp").prepend(
                    
                `<tr  style="font-weight: bold; color:green;">
                  <td>
                     ${results[res]["status_desc"]}
                                                  
                    </td> 
                    <td>${results[res]["mobile_number"]}</td>
                    <td>${results[res]["network_id"]}</td>
                    
                    <td>${results[res]["message_cost"]}</td>
                    
                                              
                                                
                                                                                             
                  </tr>
             
                `
                )
                                          }
          }

        });
      }

    function unsavedOneMsg(){

 

        $.ajax({

          url:"{% url 'unsaved_one_msg' %}",
          type:"POST",
          data:{
            phone: $("#phn").val(),
            unsavedmsg:$("#message").val(),
            csrfmiddlewaretoken: '{{ csrf_token }}',
          },
          beforeSend:function(){

          $("#plagSpinner1").show()

          },
          complete:function(){
          $("#plagSpinner1").hide()
          },
          success:function(data,status){
            var results = JSON.parse(data)
                console.log(results)
               for(res in results){
                $("#savedResp").prepend(
                    
                `<tr  style="font-weight: bold; color:green;">
                  <td>
                     ${results[res]["status_desc"]}
                                                  
                    </td> 
                    <td>${results[res]["mobile_number"]}</td>
                    <td>${results[res]["network_id"]}</td>
                    
                    <td>${results[res]["message_cost"]}</td>
                    
                                              
                                                
                                                                                             
                  </tr>
             
                `
                )
                                          }
          }

        });
    }

    function unsavedMultMsg(){



      $.ajax({

        url:"{% url 'unsaved_mult_msg' %}",
        type:"POST",
        data:{
          multphone: $("#mult_phn").val(),
          multunsavedmsg:$("#mult_msgs").val(),
          csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        beforeSend:function(){

        $("#plagSpinner2").show()

        },
        complete:function(){
        $("#plagSpinner2").hide()
        },
        success:function(data,status){
       
          var results = JSON.parse(data)
                console.log(results)
               for(res in results){

                $("#savedResp").prepend(
                    
                `<tr  style="font-weight: bold; color:green;">
                  <td>
                     ${results[res]["status_desc"]}
                                                  
                    </td> 
                    <td>${results[res]["mobile_number"]}</td>
                    <td>${results[res]["network_id"]}</td>
                    
                    <td>${results[res]["message_cost"]}</td>
                    
                                              
                                                
                                                                                             
                  </tr>
             
                `
                )
                                          }
        }

      });
}

function delContacts(){

  $.ajax({

url:"{% url 'del_contacts' %}",
type:"POST",
data:{
  id:1,
  csrfmiddlewaretoken: '{{ csrf_token }}',
},
beforeSend:function(){

$("#delSpinner").show()

},
complete:function(){
$("#delSpinner").hide()
},
success:function(data,status){

  alert(data)
    
}
  })
}


function download_csv(csv, filename) {
    var csvFile;
    var downloadLink;

    // CSV FILE
    csvFile = new Blob([csv], {type: "text/csv"});

    // Download link
    downloadLink = document.createElement("a");

    // File name
    downloadLink.download = filename;

    // We have to create a link to the file
    downloadLink.href = window.URL.createObjectURL(csvFile);

    // Make sure that the link is not displayed
    downloadLink.style.display = "none";

    // Add the link to your DOM
    document.body.appendChild(downloadLink);

    // Lanzamos
    downloadLink.click();
}

// html table converted to csv format

function export_table_to_csv(html, filename) {
	var csv = [];
	var rows = document.getElementById("table tr");
	
    for (var i = 0; i < rows.length; i++) {
		var row = [], cols = rows[i].querySelectorAll("td, th");
		
        for (var j = 0; j < cols.length; j++) 
            row.push(cols[j].innerText);
        
		csv.push(row.join(","));		
	}

    // Download CSV
    download_csv(csv.join("\n"), filename);
}

document.getElementById("msgReport").addEventListener("click", function () {
    var html = document.querySelector("table").outerHTML;
    var now = new Date().toLocaleDateString()
    var fileName = 'bulky_sms' + now
	export_table_to_csv(html, fileName);
});
</script>
{% endblock mainContent %}
